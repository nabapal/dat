{% extends 'base.html' %}
{% block title %}Team Activities{% endblock %}
{% block content %}
<style>
  /* Modern flat look for team activities page */
  body, .container-fluid {
    background: #f7f8fa !important;
  }
  .team-activities-table-container {
    background: none !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    padding: 0;
    margin: 0;
  }
  .table-flat {
    background: none;
    border: none;
    width: 100%;
    margin: 0;
  }
  .table-flat th, .table-flat td {
    border: none;
    border-bottom: 1px solid #e5e7eb;
    background: none;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
    vertical-align: middle;
  }
  .table-flat thead th {
    background: #f1f3f6;
    font-weight: 600;
    border-bottom: 2px solid #e5e7eb;
  }
  .table-flat tbody tr:last-child td {
    border-bottom: none;
  }
  .table-flat tr:hover td {
    background: #f5faff;
  }
  .badge {
    border-radius: 6px !important;
    font-size: 0.97em;
    padding: 0.45em 0.85em;
  }
  .pagination .page-link {
    border-radius: 6px !important;
  }
  .form-control, .form-select {
    border-radius: 6px !important;
  }
  .btn {
    border-radius: 6px !important;
  }
  .fw-bold {
    font-weight: 600 !important;
  }
</style>
<div class="container-fluid px-2 team-activities-table-container">
  <h2 class="mb-4">Team Activities</h2>
  <!-- Status Summary Row -->
  <div class="row mb-3 g-2">
    <div class="col-auto">
      <span class="fw-bold">Total:</span>
      <a href="{{ url_for('team_activities', assignee=request.args.get('assignee', ''), status='') }}" class="badge bg-dark text-white ms-1 text-decoration-none {% if not request.args.get('status') %}border border-2 border-primary{% endif %}">{{ summary.total }}</a>
    </div>
    <div class="col-auto">
      <span class="fw-bold">Completed:</span>
      <a href="{{ url_for('team_activities', assignee=request.args.get('assignee', ''), status='completed') }}" class="badge bg-success text-white ms-1 text-decoration-none {% if request.args.get('status') == 'completed' %}border border-2 border-success{% endif %}">{{ summary.completed }}</a>
    </div>
    <div class="col-auto">
      <span class="fw-bold">In Progress:</span>
      <a href="{{ url_for('team_activities', assignee=request.args.get('assignee', ''), status='in_progress') }}" class="badge bg-warning text-dark ms-1 text-decoration-none {% if request.args.get('status') == 'in_progress' %}border border-2 border-warning{% endif %}">{{ summary.in_progress }}</a>
    </div>
    <div class="col-auto">
      <span class="fw-bold">Pending:</span>
      <a href="{{ url_for('team_activities', assignee=request.args.get('assignee', ''), status='pending') }}" class="badge bg-secondary text-white ms-1 text-decoration-none {% if request.args.get('status') == 'pending' %}border border-2 border-secondary{% endif %}">{{ summary.pending }}</a>
    </div>
  </div>
  <!-- Team Members Row (with team lead included) -->
  {% if team_members %}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="mb-2 fw-bold">Team Members:</div>
      <div class="d-flex flex-wrap gap-2 mb-3">
        <a href="{{ url_for('team_activities', status=request.args.get('status', '')) }}" class="badge bg-dark text-white text-decoration-none {% if not request.args.get('assignee') %}border border-2 border-primary{% endif %}">All</a>
        {% for member in team_members %}
          <a href="{{ url_for('team_activities', assignee=member.id, status=request.args.get('status', '')) }}" class="badge bg-primary text-decoration-none {% if request.args.get('assignee') == member.id|string %}border border-2 border-warning{% endif %}">{{ member.username }}</a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  <!-- Search Only -->
  <div class="row mb-3">
    <div class="col-md-12">
      <form method="get" class="d-flex justify-content-end mb-0">
        <input type="text" name="search" class="form-control w-auto me-2" placeholder="Search activities..." value="{{ request.args.get('search', '') }}">
        <input type="hidden" name="per_page" value="{{ request.args.get('per_page', '10') }}">
        <input type="hidden" name="assignee" value="{{ request.args.get('assignee', '') }}">
        <input type="hidden" name="activity_type" value="{{ request.args.get('activity_type', '') }}">
        <input type="hidden" name="node_name" value="{{ request.args.get('node_name', '') }}">
        <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
        <button type="submit" class="btn btn-outline-primary">Search</button>
      </form>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-flat align-middle">
      <thead>
        <tr>
          <th>Activity ID</th>
          <th>Details</th>
          <th>Assignees</th>
          <th>Status</th>
          <th>Node</th>
          <th>Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Update Days</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for activity in activities.items %}
        <tr>
          <td class="fw-bold text-primary text-truncate">
            <a href="{{ url_for('view_updates', activity_id=activity.id) }}" class="text-decoration-underline text-primary" title="View History">
              {{ activity.activity_id }}
            </a>
          </td>
          <td class="text-truncate">{{ activity.details|truncate(30) }}</td>
          <td>
            {% for user in activity.assignees %}
              <span class="badge bg-primary me-1">{{ user.username }}</span>
            {% endfor %}
          </td>
          <td>
            <span class="badge bg-{{ 'success' if activity.status == 'completed' else ('warning' if activity.status == 'in_progress' else ('secondary' if activity.status == 'pending' else 'info')) }}">
              {{ activity.status|capitalize }}
            </span>
          </td>
          <td class="text-truncate">{{ activity.node_name }}</td>
          <td class="text-truncate">{{ activity.activity_type }}</td>
          <td class="text-truncate">{{ activity.start_date.strftime('%Y-%m-%d') }}</td>
          <td class="text-truncate">{% if activity.end_date %}{{ activity.end_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
          <td>{{ activity.update_days_count }}</td>
          <td>
            <a href="{{ url_for('edit_activity', id=activity.id) }}" class="btn btn-sm btn-outline-secondary me-1" title="Edit">
              <i class="bi bi-pencil"></i>
            </a>
            <a href="{{ url_for('add_update', activity_id=activity.id) }}" class="btn btn-sm btn-outline-success me-1" title="Add Update">
              <i class="bi bi-plus-circle"></i>
            </a>
            <form method="POST" action="{{ url_for('delete_activity', id=activity.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this activity?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="10" class="text-center">No activities found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if activities.pages is defined %}
    <div class="row align-items-center mt-3">
      <div class="col-auto">
        <form method="get" class="d-inline-flex align-items-center">
          <label for="per_page" class="me-2 mb-0">Show</label>
          <select name="per_page" id="per_page" class="form-select d-inline-block w-auto me-2" onchange="this.form.submit();">
            {% for n in [10, 20, 30, 100] %}
              <option value="{{ n }}" {% if activities.per_page == n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
          <span class="mb-0">activities per page</span>
          <input type="hidden" name="search" value="{{ request.args.get('search', '') }}">
          <input type="hidden" name="assignee" value="{{ request.args.get('assignee', '') }}">
          <input type="hidden" name="activity_type" value="{{ request.args.get('activity_type', '') }}">
          <input type="hidden" name="node_name" value="{{ request.args.get('node_name', '') }}">
          <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
        </form>
      </div>
      <div class="col">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item {% if not activities.has_prev %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('team_activities', page=activities.prev_num, search=request.args.get('search', ''), per_page=activities.per_page, assignee=request.args.get('assignee', ''), activity_type=request.args.get('activity_type', ''), node_name=request.args.get('node_name', ''), status=request.args.get('status', '')) }}">Previous</a>
            </li>
            {% for p in range(1, activities.pages + 1) %}
            <li class="page-item {% if p == activities.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('team_activities', page=p, search=request.args.get('search', ''), per_page=activities.per_page, assignee=request.args.get('assignee', ''), activity_type=request.args.get('activity_type', ''), node_name=request.args.get('node_name', ''), status=request.args.get('status', '')) }}">{{ p }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if not activities.has_next %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('team_activities', page=activities.next_num, search=request.args.get('search', ''), per_page=activities.per_page, assignee=request.args.get('assignee', ''), activity_type=request.args.get('activity_type', ''), node_name=request.args.get('node_name', ''), status=request.args.get('status', '')) }}">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
