{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Activity Tracker</h2>
    <a href="{{ url_for('add_activity') }}" class="btn btn-primary">+ Add Activity</a>
  </div>
  <!-- Status Summary Row -->
  <div class="row mb-3 g-2">
    <div class="col-auto">
      <span class="fw-bold">Total:</span>
      <a href="{{ url_for('dashboard') }}" class="badge bg-dark text-white ms-1 text-decoration-none">{{ summary.total }}</a>
    </div>
    <div class="col-auto">
      <span class="fw-bold">Completed:</span>
      <a href="{{ url_for('dashboard', status='completed') }}" class="badge bg-success text-white ms-1 text-decoration-none">{{ summary.completed }}</a>
    </div>
    <div class="col-auto">
      <span class="fw-bold">In Progress:</span>
      <a href="{{ url_for('dashboard', status='in_progress') }}" class="badge bg-warning text-dark ms-1 text-decoration-none">{{ summary.in_progress }}</a>
    </div>
    <div class="col-auto">
      <span class="fw-bold">Pending:</span>
      <a href="{{ url_for('dashboard', status='pending') }}" class="badge bg-secondary text-white ms-1 text-decoration-none">{{ summary.pending }}</a>
    </div>
  </div>
  <!-- Search Only -->
  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-md-6 col-lg-4">
      <input type="text" name="search" class="form-control" placeholder="Search activities..." value="{{ search }}">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-outline-primary">Search</button>
    </div>
  </form>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Activity ID</th>
          <th>Details</th>
          <th>Assignees</th>
          <th>Node</th>
          <th>Type</th>
          <th>Status</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Update Days</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for activity in activities.items %}
        <tr>
          <td class="fw-bold text-primary text-truncate">
            <a href="{{ url_for('view_updates', activity_id=activity.id) }}" class="text-decoration-underline text-primary" title="View History">
              {{ activity.activity_id }}
            </a>
          </td>
          <td class="text-truncate">{{ activity.details|truncate(30) }}</td>
          <td>
            {% for user in activity.assignees %}
              <span class="badge bg-primary me-1">{{ user.username }}</span>
            {% endfor %}
          </td>
          <td class="text-truncate">{{ activity.node_name }}</td>
          <td class="text-truncate">{{ activity.activity_type }}</td>
          <td>
            <span class="badge bg-{% if activity.status == 'completed' %}success{% elif activity.status == 'in_progress' %}warning{% elif activity.status == 'pending' %}secondary{% else %}info{% endif %}">
              {{ activity.status|capitalize }}
            </span>
          </td>
          <td class="text-truncate">{{ activity.start_date.strftime('%Y-%m-%d %H:%M') }}</td>
          <td class="text-truncate">{% if activity.end_date %}{{ activity.end_date.strftime('%Y-%m-%d %H:%M') }}{% else %}-{% endif %}</td>
          <td>{{ activity.update_days_count }}</td>
          <td>
            <a href="{{ url_for('edit_activity', id=activity.id) }}" class="btn btn-sm btn-outline-secondary me-1" title="Edit"><i class="bi bi-pencil"></i></a>
            <a href="{{ url_for('add_update', activity_id=activity.id) }}" class="btn btn-sm btn-outline-success me-1" title="Add Update"><i class="bi bi-plus-circle"></i></a>
            <form method="POST" action="{{ url_for('delete_activity', id=activity.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this activity?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete"><i class="bi bi-trash"></i></button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="10" class="text-center py-4">
            <div class="alert alert-info">
              No activities found. <a href="{{ url_for('add_activity') }}">Add your first activity</a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if activities.pages is defined %}
    <div class="row align-items-center mt-3">
      <div class="col-auto">
        <form method="get" class="d-inline-flex align-items-center">
          <label for="per_page" class="me-2 mb-0">Show</label>
          <select name="per_page" id="per_page" class="form-select d-inline-block w-auto me-2" onchange="this.form.submit();">
            {% for n in [10, 20, 30, 100] %}
              <option value="{{ n }}" {% if activities.per_page == n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
          <input type="hidden" name="search" value="{{ search }}">
          {% if request.args.get('status') %}
            <input type="hidden" name="status" value="{{ request.args.get('status') }}">
          {% endif %}
        </form>
      </div>
      <div class="col">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item {% if not activities.has_prev %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('dashboard', page=activities.prev_num, search=search, per_page=activities.per_page, status=request.args.get('status')) }}">Previous</a>
            </li>
            {% for p in range(1, activities.pages + 1) %}
            <li class="page-item {% if p == activities.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('dashboard', page=p, search=search, per_page=activities.per_page, status=request.args.get('status')) }}">{{ p }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if not activities.has_next %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('dashboard', page=activities.next_num, search=search, per_page=activities.per_page, status=request.args.get('status')) }}">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}