{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
/* GLOBAL COMPACT DASHBOARD STYLES */
html, body, .container-fluid, .card, .table, .form-control, .btn, .badge, .pagination, .input-group, .navbar, .sidebar, .sidebar .nav-item, .sidebar .nav-link {
  font-size: 13px !important;
}
body, .container-fluid {
  padding: 0.5rem !important;
}

h1, h2, h3, h4, h5, h6 {
  font-size: 1.1em !important;
  margin-bottom: 0.5rem !important;
}

.card, .card-body {
  padding: 0.6rem 0.8rem !important;
  margin-bottom: 0.7rem !important;
  border-radius: 0.4rem !important;
}

.table th, .table td {
  font-size: 12px !important;
  padding: 0.18rem 0.3rem !important;
  vertical-align: middle !important;
}
.table thead th {
  font-size: 12.5px !important;
  padding-top: 0.22rem !important;
  padding-bottom: 0.22rem !important;
}
.table {
  margin-bottom: 0.5rem !important;
}

.btn, .btn-sm, .btn-primary, .btn-outline-secondary, .btn-outline-success, .btn-outline-danger {
  font-size: 12px !important;
  padding: 0.18rem 0.5rem !important;
  border-radius: 0.2rem !important;
}

.badge {
  font-size: 11px !important;
  padding: 0.25em 0.5em !important;
  border-radius: 0.3em !important;
}

.input-group, .form-control {
  font-size: 12px !important;
  padding: 0.18rem 0.4rem !important;
  height: 1.7rem !important;
}

.pagination .page-link {
  font-size: 12px !important;
  padding: 0.18rem 0.5rem !important;
}

.sidebar, .sidebar .nav-item, .sidebar .nav-link {
  min-width: 170px !important;
  max-width: 170px !important;
  font-size: 13px !important;
  padding: 0.3rem 0.7rem !important;
}

@media (max-width: 1200px) {
  .sidebar, .sidebar .nav-item, .sidebar .nav-link {
    min-width: 120px !important;
    max-width: 120px !important;
    font-size: 12px !important;
    padding: 0.2rem 0.4rem !important;
  }
  .table th, .table td {
    font-size: 11px !important;
    padding: 0.12rem 0.15rem !important;
  }
}

/* Remove excessive margins and paddings from cards and rows */
.row, .mb-4, .mb-3, .mb-0, .mb-2, .mb-1 {
  margin-bottom: 0.4rem !important;
}

/* Slim down the search bar */
.input-group .form-control {
  height: 1.7rem !important;
  font-size: 12px !important;
  padding: 0.18rem 0.4rem !important;
}
.input-group-append .btn {
  height: 1.7rem !important;
  font-size: 12px !important;
  padding: 0.18rem 0.5rem !important;
}

/* Slim down the status cards */
.card .h5, .card .h3, .card .h4 {
  font-size: 1.2em !important;
}

/* Custom styles for the dashboard */
#dataTable_wrapper {
  padding: 1rem;
  border-radius: 0.4rem;
  background-color: #fff;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
  background-color: #f8f9fa;
  position: relative;
}

.table th.sorting:hover, .table th.sorting_asc:hover, .table th.sorting_desc:hover {
  cursor: pointer;
}

.table th.sorting:after, .table th.sorting_asc:after, .table th.sorting_desc:after {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  display: block;
  width: 0;
  height: 0;
  border-left: 4px solid transparent;
  border-right: 4px solid transparent;
}

.table th.sorting_asc:after {
  border-bottom: 4px solid #007bff;
}

.table th.sorting_desc:after {
  border-top: 4px solid #007bff;
}

.table td {
  vertical-align: middle;
}

.table td .badge {
  margin-bottom: 0;
}

.table td:last-child {
  white-space: nowrap;
}

.table-responsive {
  margin-bottom: 1rem;
}

.card-header {
  background-color: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  padding: 0.75rem 1.25rem;
  border-top-left-radius: 0.4rem;
  border-top-right-radius: 0.4rem;
}

.card-title {
  margin-bottom: 0;
  font-size: 1.25rem;
  font-weight: 500;
}

.card-footer {
  background-color: #f8f9fa;
  border-top: 1px solid #dee2e6;
  padding: 0.75rem 1.25rem;
  border-bottom-left-radius: 0.4rem;
  border-bottom-right-radius: 0.4rem;
}

.text-primary {
  color: #007bff !important;
}

.text-success {
  color: #28a745 !important;
}

.text-danger {
  color: #dc3545 !important;
}

.text-warning {
  color: #ffc107 !important;
}

.text-info {
  color: #17a2b8 !important;
}

.text-light {
  color: #f8f9fa !important;
}

.text-dark {
  color: #343a40 !important;
}

.bg-primary {
  background-color: #007bff !important;
}

.bg-success {
  background-color: #28a745 !important;
}

.bg-danger {
  background-color: #dc3545 !important;
}

.bg-warning {
  background-color: #ffc107 !important;
}

.bg-info {
  background-color: #17a2b8 !important;
}

.bg-light {
  background-color: #f8f9fa !important;
}

.bg-dark {
  background-color: #343a40 !important;
}

.border-primary {
  border-color: #007bff !important;
}

.border-success {
  border-color: #28a745 !important;
}

.border-danger {
  border-color: #dc3545 !important;
}

.border-warning {
  border-color: #ffc107 !important;
}

.border-info {
  border-color: #17a2b8 !important;
}

.border-light {
  border-color: #f8f9fa !important;
}

.border-dark {
  border-color: #343a40 !important;
}

.rounded {
  border-radius: 0.4rem !important;
}

.shadow {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

.opacity-75 {
  opacity: 0.75 !important;
}

.w-100 {
  width: 100% !important;
}

.mr-1 {
  margin-right: 0.25rem !important;
}

.ml-1 {
  margin-left: 0.25rem !important;
}

.mb-1 {
  margin-bottom: 0.25rem !important;
}

.mt-1 {
  margin-top: 0.25rem !important;
}

.p-1 {
  padding: 0.25rem !important;
}

.text-truncate {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.text-decoration-none {
  text-decoration: none !important;
}

.text-decoration-underline {
  text-decoration: underline !important;
}

.fas {
  font-family: "Font Awesome 5 Free";
  font-weight: 900;
}

.fa-search:before {
  content: "\f002";
}

.fa-list:before {
  content: "\f03a";
}

.fa-edit:before {
  content: "\f044";
}

.fa-plus-circle:before {
  content: "\f055";
}

.fa-trash:before {
  content: "\f1f8";
}

.fa-circle:before {
  content: "\f111";
}

.badge-primary {
  background-color: #007bff;
}

.badge-success {
  background-color: #28a745;
}

.badge-danger {
  background-color: #dc3545;
}

.badge-warning {
  background-color: #ffc107;
}

.badge-info {
  background-color: #17a2b8;
}

.badge-light {
  background-color: #f8f9fa;
}

.badge-dark {
  background-color: #343a40;
}
</style>

<div class="container-fluid">
  <!-- Page Heading -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
    <a href="{{ url_for('add_activity') }}" class="btn btn-primary btn-icon-split">
      <span class="icon text-white-50">
        <i class="fas fa-plus-circle"></i>
      </span>
      <span class="text">Add Activity</span>
    </a>
  </div>

  <!-- Status Summary Row -->
  <div class="row mb-4">
    <!-- Total Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total</div>
              <a href="{{ url_for('dashboard') }}" class="h5 mb-0 font-weight-bold text-gray-800 text-decoration-none">{{ summary.total }}</a>
            </div>
            <div class="col-auto">
              <i class="fas fa-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Dynamic Status Cards -->
    {% for status, count in summary.items() %}
      {% if status != 'total' %}
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-{{ status_color_map.get(status, 'dark') }} shadow h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-{{ status_color_map.get(status, 'dark') }} text-uppercase mb-1">{{ status.replace('_', ' ') }}</div>
                <a href="{{ url_for('dashboard', status=status) }}" class="h5 mb-0 font-weight-bold text-gray-800 text-decoration-none">{{ count }}</a>
              </div>
              <div class="col-auto">
                <i class="fas {{ status_icon_map.get(status, 'fa-circle') }} fa-2x text-{{ status_color_map.get(status, 'dark') }}"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>
  <!-- Search Only -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <form method="get" class="form-inline mb-3">
        <div class="input-group mr-2 w-100" style="max-width:400px;">
          <input type="text" name="search" class="form-control bg-light border-0 small" placeholder="Search activities..." value="{{ search }}">
          <div class="input-group-append">
            <button class="btn btn-primary" type="submit">
              <i class="fas fa-search fa-sm"></i>
            </button>
          </div>
        </div>
      </form>
      <div class="table-responsive">
        <table class="table table-bordered table-hover tablesorter" id="dataTable" cellspacing="0">
          <thead class="thead-light">
            <tr>
              <th>Activity ID</th>
              <th class="text-truncate">Details</th>
              <th>Assignees</th>
              <th class="text-truncate">Node</th>
              <th>Type</th>
              <th>Status</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th class="d-none d-md-table-cell d-lg-table-cell">Days Contributed</th>
              <th class="d-none d-md-table-cell d-lg-table-cell">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for activity in activities.items %}
            <tr>
              <td class="fw-bold text-primary text-truncate">
                <a href="{{ url_for('view_updates', activity_id=activity.id) }}" class="text-decoration-underline text-primary" title="View History">
                  {{ activity.activity_id }}
                </a>
              </td>
              <td class="text-truncate">{{ activity.details|truncate(30) }}</td>
              <td>
                {% for user in activity.assignees %}
                  <span class="badge badge-primary mr-1">{{ user.username }}</span>
                {% endfor %}
              </td>
              <td class="text-truncate">{{ activity.node_name }}</td>
              <td>{{ activity.activity_type }}</td>
              <td>
                <span class="badge badge-{{ status_color_map.get(activity.status|lower, 'light') }}">
                  {{ activity.status|capitalize }}
                </span>
              </td>
              <td>{{ activity.start_date.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ activity.end_date.strftime('%Y-%m-%d %H:%M') if activity.end_date else '-' }}</td>
              <td class="d-none d-md-table-cell d-lg-table-cell">{{ activity.update_days_count }}</td>
              <td class="d-none d-md-table-cell d-lg-table-cell">
                <a href="{{ url_for('edit_activity', id=activity.id) }}" class="btn btn-sm btn-outline-secondary mr-1" title="Edit"><i class="fas fa-edit"></i></a>
                <a href="{{ url_for('add_update', activity_id=activity.id) }}" class="btn btn-sm btn-outline-success mr-1" title="Add Update"><i class="fas fa-plus-circle"></i></a>
                <form method="POST" action="{{ url_for('delete_activity', id=activity.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this activity?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash"></i></button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="10" class="text-center py-4">
                <div class="alert alert-info mb-0">
                  No activities found. <a href="{{ url_for('add_activity') }}">Add your first activity</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if activities.pages is defined %}
        <div class="row align-items-center mt-3">
          <div class="col-auto">
            <form method="get" class="form-inline">
              <label for="per_page" class="mr-2 mb-0">Show</label>
              <select name="per_page" id="per_page" class="form-control d-inline-block w-auto mr-2" onchange="this.form.submit();">
                {% for n in [10, 20, 30, 100] %}
                  <option value="{{ n }}" {% if activities.per_page == n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
              <input type="hidden" name="search" value="{{ search }}">
              {% if request.args.get('status') %}
                <input type="hidden" name="status" value="{{ request.args.get('status') }}">
              {% endif %}
            </form>
          </div>
          <div class="col">
            <nav>
              <ul class="pagination justify-content-center mb-0">
                <li class="page-item {% if not activities.has_prev %}disabled{% endif %}">
                  <a class="page-link" href="{{ url_for('dashboard', page=activities.prev_num, search=search, per_page=activities.per_page, status=request.args.get('status')) }}">Previous</a>
                </li>
                
                {% set max_visible_pages = 5 %}
                {% set half_visible = 2 %}
                {% set start_page = [1, activities.page - half_visible]|max %}
                {% set end_page = [activities.pages, start_page + max_visible_pages - 1]|min %}
                {% set start_page = [1, end_page - max_visible_pages + 1]|max %}
                
                {% if start_page > 1 %}
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('dashboard', page=1, search=search, per_page=activities.per_page, status=request.args.get('status')) }}">1</a>
                  </li>
                  {% if start_page > 2 %}
                    <li class="page-item disabled">
                      <span class="page-link">...</span>
                    </li>
                  {% endif %}
                {% endif %}
                
                {% for p in range(start_page, end_page + 1) %}
                  <li class="page-item {% if p == activities.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('dashboard', page=p, search=search, per_page=activities.per_page, status=request.args.get('status')) }}">{{ p }}</a>
                  </li>
                {% endfor %}
                
                {% if end_page < activities.pages %}
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('dashboard', page=activities.pages, search=search, per_page=activities.per_page, status=request.args.get('status')) }}">{{ activities.pages }}</a>
                  </li>
                {% endif %}
                
                <li class="page-item {% if not activities.has_next %}disabled{% endif %}">
                  <a class="page-link" href="{{ url_for('dashboard', page=activities.next_num, search=search, per_page=activities.per_page, status=request.args.get('status')) }}">Next</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}