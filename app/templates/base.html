<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Daily Activity Tracker{% endblock %}</title>
    <!-- SB Admin 2 Fonts and Icons -->
    <link href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <!-- SB Admin 2 CSS -->
    <link href="{{ url_for('static', filename='css/sb-admin-2.min.css') }}" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='team_activities.css') }}" rel="stylesheet">
    <!-- Custom Sidebar Slim CSS -->
    <link href="{{ url_for('static', filename='css/custom-sidebar.css') }}" rel="stylesheet">
    <!-- Custom Compact Global CSS -->
    <link href="{{ url_for('static', filename='css/custom-compact.css') }}" rel="stylesheet">
    <!-- Add tablesorter JS and CSS at the end for correct order -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/theme.default.min.css">
    <!-- tablesorter JS is loaded at the end to ensure project's jQuery is used -->
    {% block extra_css %}
<style>
  /* Fully hide sidebar and expand content when .sidebar-hidden is on #wrapper */
  #wrapper.sidebar-hidden .sidebar {
    display: none !important;
  }
  #wrapper.sidebar-hidden #content-wrapper {
    margin-left: 0 !important;
    width: 100% !important;
  }
        /* Improved sorting arrows for table headers (cleaner double-triangle style) */
        .table th.sorting,
        .table th.sorting_asc,
        .table th.sorting_desc {
            position: relative;
            padding-right: 28px; /* space for arrows */
        }
        .table th.sorting:before,
        .table th.sorting:after,
        .table th.sorting_asc:before,
        .table th.sorting_desc:after {
            content: '';
            position: absolute;
            right: 8px;
            display: block;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            opacity: 0.35;
            transition: opacity .12s ease, border-color .12s ease, transform .12s ease;
        }
        /* up triangle */
        .table th.sorting:before,
        .table th.sorting_asc:before {
            border-bottom: 7px solid #6c757d;
            top: calc(50% - 6px);
            transform: translateY(-2px);
        }
        /* down triangle */
        .table th.sorting:after,
        .table th.sorting_desc:after {
            border-top: 7px solid #6c757d;
            top: calc(50% + 0px);
            transform: translateY(2px);
        }
        .table th.sorting:hover:before,
        .table th.sorting:hover:after { opacity: 0.6; }
        /* active states */
        .table th.sorting_asc:before { border-bottom-color: #007bff; opacity: 1; }
        .table th.sorting_desc:after { border-top-color: #007bff; opacity: 1; }
        /* make smaller for compact tables */
        .table.table-sm th.sorting:before,
        .table.table-sm th.sorting:after { border-left-width:5px; border-right-width:5px; border-top-width:6px; border-bottom-width:6px; }
</style>
{% endblock %}
</head>
<body id="page-top">
<!-- Page Wrapper -->
<div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar" style="width:10px; min-width:140px;">
        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/">
            <div class="sidebar-brand-icon rotate-n-15">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="sidebar-brand-text mx-3">Activity Tracker</div>
        </a>
        <hr class="sidebar-divider my-0">
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('dashboard') }}">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span></a>
        </li>
        {% if current_user.is_authenticated and current_user.role in ['team_lead', 'super_lead'] %}
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('team_activities') }}">
                <i class="fas fa-fw fa-users"></i>
                <span>Team Activities</span></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('team_management') }}">
                <i class="fas fa-fw fa-users-cog"></i>
                <span>Team Management</span></a>
        </li>
        {% endif %}
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('team_management') }}">
                <i class="fas fa-fw fa-users-cog"></i>
                <span>Team Management</span></a>
        </li>
        {% endif %}
        {% if current_user.is_authenticated and current_user.role == 'team_lead' %}
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('manage_team_dropdowns') }}">
                <i class="fas fa-fw fa-cogs"></i>
                <span>Attributes</span></a>
        </li>
        {% endif %}
        <hr class="sidebar-divider d-none d-md-block">
    </ul>
    <!-- End of Sidebar -->
    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <!-- Sidebar Toggle (Topbar) -->
                <button id="sidebarToggle" class="btn btn-link d-md-inline d-lg-inline rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>
                <!-- Topbar Navbar -->
                <ul class="navbar-nav ml-auto">
                    {% if current_user.is_authenticated %}
                        <!-- Financial Year Dropdown -->
                        <li class="nav-item dropdown no-arrow mr-3">
                          <form method="post" action="{{ url_for('set_financial_year') }}" class="form-inline my-2 my-lg-0">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <select name="financial_year" class="form-control form-control-sm mr-2" onchange="this.form.submit()">
                              {% for fy in available_financial_years %}
                                <option value="{{ fy }}" {% if fy == selected_financial_year %}selected{% endif %}>FY{{ fy }}</option>
                              {% endfor %}
                            </select>
                            <noscript><button type="submit" class="btn btn-sm btn-primary">Go</button></noscript>
                          </form>
                        </li>
                        <!-- End Financial Year Dropdown -->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">{{ current_user.username }}</span>
                                <i class="fas fa-user-circle fa-lg"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="{{ url_for('change_password') }}">
                                    <i class="fas fa-key fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Change Password
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="{{ url_for('logout') }}">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Logout
                                </a>
                            </div>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            <!-- End of Topbar -->
            <div class="container-fluid">
                {% with messages = get_flashed_messages(with_categories=true) %}
                  {% if messages %}
                    {% for category, message in messages %}
                      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                    {% endfor %}
                  {% endif %}
                {% endwith %}
                {% block content %}{% endblock %}
            </div>
        </div>
        <!-- End of Main Content -->
    </div>
    <!-- End of Content Wrapper -->
</div>
<!-- End of Page Wrapper -->
<!-- SB Admin 2 JS and dependencies -->
<script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/jquery-easing/jquery.easing.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>
<!-- Optional: Chart.js, DataTables, etc. -->
<script src="{{ url_for('static', filename='vendor/chart.js/Chart.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/datatables/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/datatables/dataTables.bootstrap4.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/datatables/dataTables.bootstrap4.min.css') }}">
{% block extra_js %}
<script>
$(document).ready(function() {
    // Enable DataTables on dashboard table, hide search and length menu
    $('#dataTable').DataTable({
        paging: false,
        info: false,
        searching: false,
        ordering: true,
        order: []
    });
    // Try to initialize resizable columns for dashboard table after DataTables init
    try {
        if ($.fn && $.fn.colResizable) {
            initResizableTable('dataTable');
        } else {
            console.warn('colResizable plugin not found; resizable columns disabled for #dataTable');
        }
    } catch (err) { console.warn('initResizable for #dataTable failed', err); }
    $('#sidebarToggle').on('click', function(e) {
        $('#wrapper').toggleClass('sidebar-hidden');
        // Persist the sidebar hidden state so it survives page reloads
        try {
            if ($('#wrapper').hasClass('sidebar-hidden')) {
                localStorage.setItem('sidebarHidden', '1');
            } else {
                localStorage.removeItem('sidebarHidden');
            }
        } catch (err) {
            console.warn('localStorage not available for sidebar state persistence', err);
        }
    });
    // Restore persisted sidebar state on load
    try {
        if (localStorage.getItem('sidebarHidden') === '1') {
            $('#wrapper').addClass('sidebar-hidden');
        }
    } catch (err) {
        // ignore
    }
});
</script>
<!-- colResizable plugin for drag-to-resize table columns -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/colresizable/1.6/colResizable-1.6.min.js"></script>
<style>
/* small grip style for column resize */
.col-resize-grip { width: 6px; height: 100%; background: transparent; display:block; }
.dragging { cursor: col-resize; }
.native-col-grip { background: rgba(0,0,0,0); transition: background .12s ease; }
.native-col-grip:hover { background: rgba(0,0,0,0.06); }
</style>
<script>
function saveColWidths(tableId) {
    try {
        var widths = [];
        $('#' + tableId + ' thead th').each(function() { widths.push($(this).outerWidth()); });
        localStorage.setItem('colWidths:' + tableId, JSON.stringify(widths));
    } catch (err) { console.warn('saveColWidths failed', err); }
}
function restoreColWidths(tableId) {
    try {
        var raw = localStorage.getItem('colWidths:' + tableId);
        if (!raw) return;
        var widths = JSON.parse(raw);
        $('#' + tableId + ' thead th').each(function(i) { if (widths[i]) $(this).css('width', widths[i] + 'px'); });
    } catch (err) { console.warn('restoreColWidths failed', err); }
}
function initResizableTable(tableId) {
    if (!$.fn || !$.fn.colResizable) {
        console.warn('initResizableTable: colResizable not available for', tableId);
        return;
    }
    var $table = $('#' + tableId);
    if (!$table.length) {
        console.warn('initResizableTable: table not found', tableId);
        return;
    }
    // avoid double-initializing if grips already present (colResizable uses class JCLRgrip)
    if ($table.find('.JCLRgrip, .col-resize-grip').length) {
        console.log('initResizableTable: already initialized for', tableId);
        return;
    }
    console.log('initResizableTable: initializing', tableId);
    restoreColWidths(tableId);
    try {
        $('#' + tableId).colResizable({
            liveDrag: true,
            gripInnerHtml: '<div class="col-resize-grip"></div>',
            draggingClass: 'dragging',
            onResize: function() { saveColWidths(tableId); }
        });
        // ensure widths saved when drag ends
        $('#' + tableId + ' thead').on('mouseup touchend', function() { saveColWidths(tableId); });
    } catch (err) { console.warn('initResizableTable failed for', tableId, err); }
}
function resetColWidths(tableId) {
    try { localStorage.removeItem('colWidths:' + tableId); location.reload(); } catch (err) { console.warn('resetColWidths failed', err); }
}
// Native fallback resizer (no dependency) ---------------------------------------------------------
function initNativeResizable(tableId) {
    var $table = $('#' + tableId);
    if (!$table.length) return;
    if ($table.data('nativeResizable')) { console.log('native resizer already initialized for', tableId); return; }
    console.log('initNativeResizable: initializing native resizer for', tableId);
    $table.css('table-layout', 'fixed');
    var $ths = $table.find('thead th');
    // ensure each th has an explicit width
    $ths.each(function() {
        var $th = $(this);
        if (!$th.width() || $th.css('width') === 'auto') {
            $th.width($th.width());
        }
    });
    // create grips
    // prefer the .table-responsive ancestor if present so grips align with scrollable area
    var $container = $table.closest('.table-responsive');
    if (!$container.length) $container = $table.parent();
    // ensure container is positioned so absolute grips align correctly and allow visible overflow
    try {
        var pos = $container.css('position');
        if (!pos || pos === 'static') $container.css('position', 'relative');
        // make sure grips are visible (some wrappers use overflow:hidden)
        var ov = $container.css('overflow');
        if (!ov || ov === 'hidden') $container.css('overflow', 'visible');
    } catch (err) { }
    $ths.each(function(i) {
        if (i === $ths.length - 1) return; // no grip after last
        var $th = $(this);
        var grip = $('<div class="native-col-grip" data-idx="' + i + '" style="position:absolute; width:8px; top:0; bottom:0; cursor:col-resize; z-index:10;"></div>');
        $container.append(grip);
        // small timeout to ensure DOM layout stabilized (DataTables/Bootstrap may adjust header)
        setTimeout(function() { positionGrip(grip, $th); }, 30);
        console.log('initNativeResizable: added grip for', tableId, 'col', i);

        grip.on('mousedown touchstart', function(e) {
            e.preventDefault();
            var startX = (e.touches ? e.touches[0].pageX : e.pageX);
            var leftTh = $ths.eq(i);
            var rightTh = $ths.eq(i+1);
            var leftW = leftTh.outerWidth();
            var rightW = rightTh.outerWidth();
            $(document).on('mousemove.nativeResize touchmove.nativeResize', function(ev) {
                var curX = (ev.touches ? ev.touches[0].pageX : ev.pageX);
                var delta = curX - startX;
                var newLeft = Math.max(40, leftW + delta);
                var newRight = Math.max(40, rightW - delta);
                leftTh.width(newLeft);
                rightTh.width(newRight);
                // reposition grips as widths change
                $ths.each(function(j){ var $tj = $(this); var g = $container.find('.native-col-grip[data-idx="'+j+'"]'); if (g.length) positionGrip(g, $tj); });
            });
            $(document).one('mouseup touchend', function() {
                $(document).off('.nativeResize');
                saveColWidths(tableId);
            });
        });
    });
    // reposition on window resize
    $(window).on('resize.nativeResize', function(){ $ths.each(function(j){ var $tj = $(this); var g = $container.find('.native-col-grip[data-idx="'+j+'"]'); if (g.length) positionGrip(g, $tj); }); });
    $table.data('nativeResizable', true);

    function positionGrip($grip, $th) {
        var off = $th.offset();
        var containerOff = $container.offset();
        var left = off.left + $th.outerWidth() - containerOff.left - 4; // center grip
        $grip.css('left', left + 'px');
    }
}

// If plugin fails to load, fallback to native resizer for both tables; also fall back
// when plugin exists but didn't create grips after a short interval
function ensureResizableFallback() {
    try {
        if (!($.fn && $.fn.colResizable)) {
            console.log('colResizable not available; initializing native resizer fallback');
            initNativeResizable('dataTable');
            initNativeResizable('teamActivitiesTable');
            return;
        }
        // plugin exists; check for grips and fallback if none are present after init
        setTimeout(function(){ checkAndFallback('dataTable'); }, 200);
        setTimeout(function(){ checkAndFallback('teamActivitiesTable'); }, 200);
        // a second check later in case of slower rendering
        setTimeout(function(){ checkAndFallback('dataTable'); }, 1200);
        setTimeout(function(){ checkAndFallback('teamActivitiesTable'); }, 1200);

        function checkAndFallback(tableId) {
            var $t = $('#' + tableId);
            if (!$t.length) return;
            var hasGrip = $t.find('.JCLRgrip, .col-resize-grip, .native-col-grip').length > 0;
            if (!hasGrip) {
                console.log('no plugin grips found for', tableId, '; initializing native fallback');
                initNativeResizable(tableId);
            }
        }
    } catch (err) { console.warn('ensureResizableFallback failed', err); }
}

// Initialize tooltips and resizable tables after window load (ensures DataTables is ready)
$(window).on('load', function() {
    try { $('[data-toggle="tooltip"]').tooltip({container:'body'}); } catch (err) {}
    // initialize resizable for known tables
    function ensureColResizable(cb) {
        if ($.fn && $.fn.colResizable) return cb();
        // try loading from jsDelivr as a fallback
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/colresizable@1.6/colResizable-1.6.min.js';
        script.onload = function() { console.log('colResizable loaded from fallback'); cb(); };
        script.onerror = function() { console.warn('failed to load colResizable fallback'); };
        document.head.appendChild(script);
    }
    ensureColResizable(function() {
        initResizableTable('dataTable');
        initResizableTable('teamActivitiesTable');
        // if plugin missing or did not install grips correctly, ensure fallback
        ensureResizableFallback();
    });
});
</script>
{% endblock %}
</body>
</html>
